<?php
include_once "assets/lib/config.php";

include_once "assets/lib/functions.php";


require 'assets/lib/php-export-data.class.php';
$user_id=$_REQUEST['uID'];
$when=clean($_REQUEST['when']);

$user_name=get_name($user_id);
$q=$mysqli->query("SELECT a.`dealer_id` as dealer_id, made_by,visted,date_visted,`startdate`,business_name FROM `tbl_route_plan` a INNER JOIN tbl_dealers b on a.dealer_id=b.dealer_id WHERE date(startdate)='$when' and made_by=$user_id and a.status=0") or die($mysqli->err);
// 'browser' tells the library to stream the data directly to the browser.
// other options are 'file' or 'string'

$exporter = new ExportDataExcel('browser', $user_name."-".$when.".xls");

$exporter->initialize(); // starts streaming data to web browser
///header
$exporter->addRow(array($user_name,"Outlet" ,"Date Planned", "Date Visisted","Availability","Price Compliance","Gold","Silver","Bronze"));
// pass addRow() an array and it converts it to Excel XML format and sends 
// it to the browser
$i=1;
while($row=mysqli_fetch_array($q)){ $dealer_id=$row['dealer_id'];
	$exporter->addRow(array($i, $row['business_name'],$row['startdate'] , $row['date_visted'],outlet_availability($dealer_id,$when,"Availability"), outlet_availability($dealer_id,$when,"Pricing"),outlet_visibility($dealer_id,$when,"Visibility","Gold"), outlet_visibility($dealer_id,$when,"Visibility","Silver"), outlet_visibility($dealer_id,$when,"Visibility","Bronze"))); 
	$i++;
	}




$exporter->finalize(); // writes the footer, flushes remaining data to browser.

exit(); // all done
?>